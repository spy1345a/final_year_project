<!DOCTYPE html>
<html>
<head>
    <title>Expenses</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: Arial;
            padding: 30px;
            background: #f5f5f5;
        }

        table {
            border-collapse: collapse;
            width: 80%;
            background: white;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        th {
            background: #222;
            color: white;
        }

        tr:nth-child(even) {
            background: #f2f2f2;
        }

        button {
            padding: 6px 10px;
            cursor: pointer;
        }

        .danger {
            background: #c0392b;
            color: white;
            border: none;
        }

        .chart-container {
            width: 500px;
            margin-bottom: 40px;
        }
    </style>
</head>

<body>

<h1>Recent Expenses</h1>

<a href="/dashboard">‚¨Ö Back to Dashboard</a>

<br><br>

<a href="/expenses/export">
    <button>‚¨á Export as CSV</button>
</a>

<br><br>

<h3>Import Expenses (CSV)</h3>

<form action="/expenses/import"
      method="POST"
      enctype="multipart/form-data">

    <input type="file" name="file" accept=".csv" required>
    <button type="submit">‚¨Ü Import CSV</button>
</form>

<br><br>

<!-- ‚úÖ DELETE ALL EXPENSES BUTTON -->
<form action="/expenses/delete-all" method="POST">
    <button class="danger"
        onclick="return confirm('Delete ALL expenses? This cannot be undone!')">
        üóë Delete All Expenses
    </button>
</form>

<br><br>

<!-- üç© DONUT CHART -->
<h2>Expense Category Breakdown</h2>

<div class="chart-container">
    <canvas id="expenseChart"></canvas>
</div>

<br><br>

<table>
    <tr>
        <th>ID</th>
        <th>Description</th>
        <th>Amount</th>
        <th>Date</th>
        <th>Action</th>
    </tr>

    {% for expense in expenses %}
    <tr>
        <td>{{ expense.id }}</td>
        <td>{{ expense.description }}</td>
        <td>‚Çπ {{ expense.amount }}</td>

        <td>
            {{ expense.created_at.split('T')[0] }}
            {{ expense.created_at.split('T')[1][:5] }}
        </td>

        <td>
            <form action="/expenses/delete/{{ expense.id }}" method="POST">
                <button type="submit"
                        onclick="return confirm('Delete this expense?')">
                    ‚ùå Remove
                </button>
            </form>
        </td>
    </tr>
    {% endfor %}
</table>

<!-- DONUT CHART SCRIPT -->
<script>

const labels = {{ chart_labels | tojson }};
const values = {{ chart_values | tojson }};
const totalAmount = {{ total_amount }};

const colors = [
    "#FF6384",
    "#36A2EB",
    "#FFCE56",
    "#4BC0C0",
    "#9966FF",
    "#FF9F40",
    "#2ecc71"
];

const centerTextPlugin = {
    id: "centerText",

    afterDraw(chart) {
        const { ctx } = chart;

        ctx.save();

        ctx.font = "bold 22px Arial";
        ctx.fillStyle = "#333";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";

        const centerX = chart.getDatasetMeta(0).data[0].x;
        const centerY = chart.getDatasetMeta(0).data[0].y;

        ctx.fillText("Total", centerX, centerY - 15);

        ctx.font = "bold 26px Arial";
        ctx.fillStyle = "#000";

        ctx.fillText("‚Çπ " + totalAmount.toLocaleString(), centerX, centerY + 15);

        ctx.restore();
    }
};

const ctx = document.getElementById("expenseChart");

new Chart(ctx, {
    type: "doughnut",

    data: {
        labels: labels,
        datasets: [{
            data: values,
            backgroundColor: colors,
            hoverOffset: 30
        }]
    },

    options: {
        cutout: "65%",
        plugins: {
            legend: {
                position: "right"
            }
        }
    },

    plugins: [centerTextPlugin]
});

</script>

</body>
</html>